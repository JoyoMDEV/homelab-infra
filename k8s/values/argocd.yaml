## ArgoCD values for homelab
## Tailscale-only, single node, no HA

global:
  domain: argocd.homelab.local

# Disable HA (single node)
controller:
  replicas: 1

server:
  replicas: 1

  # Disable TLS on argocd-server (Traefik handles TLS)
  extraArgs:
    - --insecure

  ingress:
    enabled: true
    ingressClassName: traefik
    hosts:
      - argocd.homelab.local
    tls: []

repoServer:
  replicas: 1

applicationSet:
  replicas: 1

redis:
  enabled: true

# Keycloak OIDC wird verwendet
dex:
  enabled: false

configs:
  params:
    server.insecure: true

  cm:
    users.anonymous.enabled: "false"
    timeout.reconciliation: 180s
    url: https://argocd.homelab.local

    oidc.config: |
      name: Keycloak
      issuer: https://auth.homelab.local/realms/homelab
      clientID: argocd
      clientSecret: $oidc.keycloak.clientSecret
      # rootCA is stored in argocd-secret (not in Git) and injected here.
      # To set it: kubectl patch secret argocd-secret -n argocd --type merge \
      #   -p '{"stringData":{"oidc.keycloak.rootCA":"<CA_CERT>"}}'
      rootCA: $oidc.keycloak.rootCA
      requestedScopes:
        - openid
        - profile
        - email
      requestedIDTokenClaims:
        groups:
          essential: true

    resource.customizations.health.argoproj.io_Application: |
      hs = {}
      hs.status = "Healthy"
      hs.message = ""
      if obj.status ~= nil then
        if obj.status.health ~= nil then
          hs.status = obj.status.health.status
          if obj.status.health.message ~= nil then
            hs.message = obj.status.health.message
          end
        end
      end
      return hs

  rbac:
    policy.csv: |
      g, argocd-admins, role:admin
    policy.default: role:readonly
    scopes: '[groups]'
