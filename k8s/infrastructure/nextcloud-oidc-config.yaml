---
# Nextcloud OIDC Login Konfiguration via oidc_login App
# Wird als PHP-Config-Datei in /var/www/html/config/ gemountet.
# Nextcloud liest alle *.config.php Dateien in diesem Verzeichnis automatisch.
#
# Voraussetzung: oidc_login App muss installiert sein (siehe initContainer unten)
# Keycloak Client: siehe docs/keycloak-setup.md Schritt 7
apiVersion: v1
kind: ConfigMap
metadata:
  name: nextcloud-oidc-config
  namespace: productivity
data:
  oidc.config.php: |
    <?php
    $CONFIG = array(
      // ── App aktivieren ────────────────────────────────────────────
      'oidc_login_provider_url'           => 'https://auth.homelab.local/realms/homelab',
      'oidc_login_client_id'              => 'nextcloud',
      // Secret kommt aus der Env-Variable, wird unten per secretKeyRef gesetzt
      'oidc_login_client_secret'          => getenv('OIDC_CLIENT_SECRET'),

      // ── Login-Verhalten ────────────────────────────────────────────
      // false = Login-Seite zeigt sowohl OIDC-Button als auch lokalen Login
      // true  = direkt zu Keycloak weiterleiten (kein lokaler Login mehr)
      'oidc_login_auto_redirect'          => false,

      // Lokaler Admin-Login bleibt möglich (wichtig für Notfall-Zugriff)
      'oidc_login_hide_password_form'     => false,

      // ── Attribute-Mapping (Keycloak → Nextcloud) ──────────────────
      // Muss zum Keycloak Token-Claim passen
      'oidc_login_attributes' => array(
        'id'          => 'preferred_username',
        'name'        => 'name',
        'mail'        => 'email',
        'quota'       => 'nextcloud_quota',   // optional: Keycloak-Claim für Quota
        'groups'      => 'groups',            // Gruppen aus Keycloak übernehmen
      ),

      // ── Gruppen-Sync ───────────────────────────────────────────────
      // Nextcloud-Gruppen werden bei jedem Login mit Keycloak-Gruppen synchronisiert
      'oidc_login_use_id_token'           => false,
      'oidc_login_update_avatar'          => false,

      // ── Sicherheit ────────────────────────────────────────────────
      // CA-Zertifikat für TLS-Verifikation gegen auth.homelab.local
      // Das homelab-ca Secret wird vom cert-sync CronJob in den Namespace injiziert
      'oidc_login_tls_verify'             => true,

      // ── Benutzer-Provisionierung ──────────────────────────────────
      // Legt automatisch neue Nextcloud-Benutzer an wenn sie sich via OIDC einloggen
      'oidc_login_create_user'            => true,

      // Standard-Quota für neu angelegte Benutzer (leer = unlimitiert)
      'oidc_login_default_quota'          => '',

      // ── Scopes ────────────────────────────────────────────────────
      'oidc_login_scope'                  => 'openid profile email groups',

      // ── Code Flow (PKCE) ──────────────────────────────────────────
      'oidc_login_code_challenge_method'  => 'S256',

      // ── Logout ────────────────────────────────────────────────────
      // Beim Nextcloud-Logout auch bei Keycloak ausloggen
      'oidc_login_logout_url'             => 'https://auth.homelab.local/realms/homelab/protocol/openid-connect/logout',

      // ── Button-Text auf der Login-Seite ───────────────────────────
      'oidc_login_button_text'            => 'Mit Keycloak anmelden',
    );
