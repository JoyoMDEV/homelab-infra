---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}
  labels:
    app: gitlab
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: gitlab
  template:
    metadata:
      labels:
        app: gitlab
    spec:
      containers:
        - name: gitlab
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          env:
            - name: GITLAB_OMNIBUS_CONFIG
              value: |
                external_url 'http://{{ .Values.hostname }}'
                nginx['listen_port'] = 80
                nginx['listen_https'] = false
                nginx['server_name'] = '_'
                postgresql['enable'] = false
                gitlab_rails['db_adapter'] = 'postgresql'
                gitlab_rails['db_encoding'] = 'unicode'
                gitlab_rails['db_host'] = 'homelab-pg-rw.infrastructure.svc.cluster.local'
                gitlab_rails['db_port'] = 5432
                gitlab_rails['db_username'] = 'gitlab'
                gitlab_rails['db_password'] = ENV['DB_PASSWORD']
                gitlab_rails['db_database'] = 'gitlab'
                redis['enable'] = false
                gitlab_rails['redis_host'] = 'redis-master.infrastructure.svc.cluster.local'
                gitlab_rails['redis_port'] = 6379
                gitlab_rails['redis_password'] = ENV['REDIS_PASSWORD']
                registry_external_url 'http://registry.homelab.local'
                registry['enable'] = true
                registry_nginx['listen_port'] = 5050
                registry_nginx['listen_https'] = false
                prometheus_monitoring['enable'] = false
                puma['worker_processes'] = 2
                sidekiq['max_concurrency'] = 10
                {{- if .Values.oidc.enabled }}
                gitlab_rails['omniauth_enabled'] = true
                gitlab_rails['omniauth_allow_single_sign_on'] = ['openid_connect']
                gitlab_rails['omniauth_block_auto_created_users'] = false
                gitlab_rails['omniauth_auto_link_ldap_user'] = true
                gitlab_rails['omniauth_providers'] = [{ name: 'openid_connect', label: 'Keycloak', args: { name: 'openid_connect', scope: ['openid', 'profile', 'email'], response_type: 'code', issuer: '{{ .Values.oidc.issuer }}', discovery: true, client_auth_method: 'query', uid_field: 'preferred_username', pkce: true, client_options: { identifier: '{{ .Values.oidc.clientId }}', secret: ENV['OIDC_CLIENT_SECRET'], redirect_uri: 'http://{{ .Values.hostname }}/users/auth/openid_connect/callback' } } }]
                {{- end }}
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: gitlab-secret
                  key: db-password
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: gitlab-secret
                  key: redis-password
            - name: OIDC_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: gitlab-secret
                  key: oidc-client-secret
          ports:
            - name: http
              containerPort: 80
            - name: ssh
              containerPort: 22
            - name: registry
              containerPort: 5050
          volumeMounts:
            - name: config
              mountPath: /etc/gitlab
            - name: data
              mountPath: /var/opt/gitlab
            - name: logs
              mountPath: /var/log/gitlab
          resources:
            requests:
              memory: {{ .Values.resources.requests.memory }}
              cpu: {{ .Values.resources.requests.cpu | quote }}
            limits:
              memory: {{ .Values.resources.limits.memory }}
          startupProbe:
            httpGet:
              path: /-/liveness
              port: 80
            failureThreshold: 60
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /-/readiness
              port: 80
            initialDelaySeconds: 0
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /-/liveness
              port: 80
            initialDelaySeconds: 0
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: {{ .Release.Name }}-config
        - name: data
          persistentVolumeClaim:
            claimName: {{ .Release.Name }}-data
        - name: logs
          persistentVolumeClaim:
            claimName: {{ .Release.Name }}-logs
