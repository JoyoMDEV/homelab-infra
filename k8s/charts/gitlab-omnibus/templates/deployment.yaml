---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}
  labels:
    app: gitlab
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: gitlab
  template:
    metadata:
      labels:
        app: gitlab
    spec:
      initContainers:
        - name: install-ca
          image: alpine:3.19
          command:
            - sh
            - -c
            - |
              mkdir -p /etc/gitlab/trusted-certs
              cp /ca-certs/homelab-ca.crt /etc/gitlab/trusted-certs/homelab-ca.crt
              echo "CA cert installed to /etc/gitlab/trusted-certs/"
              ls -la /etc/gitlab/trusted-certs/
          volumeMounts:
            - name: homelab-ca
              mountPath: /ca-certs
              readOnly: true
            - name: config
              mountPath: /etc/gitlab
      containers:
        - name: gitlab
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          env:
            - name: GITLAB_OMNIBUS_CONFIG
              value: |
                external_url 'https://{{ .Values.hostname }}'
                nginx['listen_port'] = 80
                nginx['listen_https'] = false
                nginx['server_name'] = '_'
                nginx['proxy_set_headers'] = {
                  "X-Forwarded-Proto" => "https",
                  "X-Forwarded-Ssl" => "on"
                }
                postgresql['enable'] = false
                gitlab_rails['db_adapter'] = 'postgresql'
                gitlab_rails['db_encoding'] = 'unicode'
                gitlab_rails['db_host'] = 'homelab-pg-rw.infrastructure.svc.cluster.local'
                gitlab_rails['db_port'] = 5432
                gitlab_rails['db_username'] = 'gitlab'
                gitlab_rails['db_password'] = ENV['DB_PASSWORD']
                gitlab_rails['db_database'] = 'gitlab'
                redis['enable'] = false
                gitlab_rails['redis_host'] = 'redis-master.infrastructure.svc.cluster.local'
                gitlab_rails['redis_port'] = 6379
                gitlab_rails['redis_password'] = ENV['REDIS_PASSWORD']
                registry_external_url 'https://registry.homelab.local'
                registry['enable'] = true
                registry_nginx['listen_port'] = 5050
                registry_nginx['listen_https'] = false
                prometheus_monitoring['enable'] = false
                puma['worker_processes'] = 2
                sidekiq['max_concurrency'] = 10
                gitlab_rails['secret_key_base'] = ENV['GITLAB_SECRET_KEY_BASE']
                gitlab_rails['db_key_base'] = ENV['GITLAB_DB_KEY_BASE']
                gitlab_rails['otp_key_base'] = ENV['GITLAB_OTP_KEY_BASE']
                gitlab_rails['ci_job_token_signing_key'] = ENV['GITLAB_CI_JOB_TOKEN_SIGNING_KEY']
                gitlab_rails['gitlab_shell_ssh_port'] = 2222
                {{- if .Values.oidc.enabled }}
                gitlab_rails['omniauth_enabled'] = true
                gitlab_rails['omniauth_allow_single_sign_on'] = ['openid_connect']
                gitlab_rails['omniauth_block_auto_created_users'] = false
                gitlab_rails['omniauth_auto_link_ldap_user'] = true
                gitlab_rails['omniauth_providers'] = [{ name: 'openid_connect', label: 'Keycloak', args: { name: 'openid_connect', scope: ['openid', 'profile', 'email'], response_type: 'code', issuer: '{{ .Values.oidc.issuer }}', discovery: true, client_auth_method: 'query', uid_field: 'preferred_username', pkce: true, client_options: { identifier: '{{ .Values.oidc.clientId }}', secret: ENV['OIDC_CLIENT_SECRET'], redirect_uri: 'https://{{ .Values.hostname }}/users/auth/openid_connect/callback' } } }]
                {{- end }}
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: gitlab-secret
                  key: db-password
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: gitlab-secret
                  key: redis-password
            - name: OIDC_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: gitlab-secret
                  key: oidc-client-secret
            - name: GITLAB_SECRET_KEY_BASE
              valueFrom:
                secretKeyRef:
                  name: gitlab-rails-secrets
                  key: secret_key_base
            - name: GITLAB_DB_KEY_BASE
              valueFrom:
                secretKeyRef:
                  name: gitlab-rails-secrets
                  key: db_key_base
            - name: GITLAB_OTP_KEY_BASE
              valueFrom:
                secretKeyRef:
                  name: gitlab-rails-secrets
                  key: otp_key_base
            - name: GITLAB_CI_JOB_TOKEN_SIGNING_KEY
              valueFrom:
                secretKeyRef:
                  name: gitlab-rails-secrets
                  key: ci_job_token_signing_key

          ports:
            - name: http
              containerPort: 80
            - name: ssh
              containerPort: 22
              hostPort: 2222
            - name: registry
              containerPort: 5050
          volumeMounts:
            - name: config
              mountPath: /etc/gitlab
            - name: data
              mountPath: /var/opt/gitlab
            - name: logs
              mountPath: /var/log/gitlab

          resources:
            requests:
              memory: {{ .Values.resources.requests.memory }}
              cpu: {{ .Values.resources.requests.cpu | quote }}
            limits:
              memory: {{ .Values.resources.limits.memory }}
          startupProbe:
            exec:
              command:
                - curl
                - -sf
                - http://127.0.0.1/-/liveness
            failureThreshold: 120
            periodSeconds: 10
          livenessProbe:
            exec:
              command:
                - curl
                - -sf
                - http://127.0.0.1/-/liveness
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
          readinessProbe:
            exec:
              command:
                - curl
                - -sf
                - http://127.0.0.1/-/readiness
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 3
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: {{ .Release.Name }}-config
        - name: data
          persistentVolumeClaim:
            claimName: {{ .Release.Name }}-data
        - name: logs
          persistentVolumeClaim:
            claimName: {{ .Release.Name }}-logs
        - name: homelab-ca
          secret:
            secretName: homelab-ca
