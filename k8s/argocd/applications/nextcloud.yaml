---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: nextcloud
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://nextcloud.github.io/helm
    chart: nextcloud
    # Chart 6.x hatte einen Bug: configs: + extraVolumeMounts erzeugten doppelte
    # mountPaths → "must be unique" Fehler. Chart 8.x behebt das.
    targetRevision: 8.*
    helm:
      values: |
        image:
          flavor: fpm-alpine

        nextcloud:
          host: nextcloud.homelab.local
          username: admin
          password: "" # gesetzt via existingSecret

          existingSecret:
            enabled: true
            secretName: nextcloud-secret
            usernameKey: nextcloud-username
            passwordKey: nextcloud-password

          # postStart Hook – läuft nach Container-Start im selben Container-Kontext
          # wie Nextcloud selbst. Erledigt in einem Schritt:
          #   1. homelab-CA ans Alpine-Bundle anhängen (/etc/ssl/cert.pem)
          #      PHP liest auf Alpine /etc/ssl/cert.pem – update-ca-certificates
          #      schreibt nur nach /etc/ssl/certs/ und greift daher nicht für PHP.
          #   2. Nextcloud installieren falls noch nicht installiert
          #   3. trusted_domain setzen
          #   4. Apps aktivieren:
          #      - oidc_login    (Keycloak SSO)
          #      - files_external (Storage Box via WebDAV)
          #      - mail          (Webmailer für externen IMAP/SMTP)
          #      - calendar      (CalDAV-Server)
          #      - contacts      (CardDAV-Server)
          #      - notes         (Markdown-Notizen)
          lifecycle:
            postStart:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - |
                    # set -e erst NACH dem CA-Block – grep gibt exit 1 zurück wenn
                    # kein Match gefunden wird, was set -e vorzeitig abbrechen lässt.

                    # ── 1. homelab-CA ans Alpine PHP-Bundle anhängen ──────────
                    # PHP sucht auf Alpine nach /etc/ssl/cert.pem (nicht /etc/ssl/certs/).
                    # update-ca-certificates greift nicht – CA direkt anhängen.
                    # Idempotenz: CA nur anhängen wenn sie noch nicht im Bundle ist.
                    # Fingerprint-Vergleich statt grep -qF um set -e Probleme zu vermeiden.
                    echo "==> Registriere homelab CA..."
                    CA_FINGERPRINT=$(openssl x509 -noout -fingerprint \
                      -in /etc/ssl/certs/homelab-ca.pem 2>/dev/null | cut -d= -f2)
                    BUNDLE_HAS_CA=$(openssl crl2pkcs7 -nocrl -certfile /etc/ssl/cert.pem 2>/dev/null \
                      | openssl pkcs7 -print_certs -noout 2>/dev/null \
                      | grep -c "$CA_FINGERPRINT" 2>/dev/null || echo "0")
                    if [ "${BUNDLE_HAS_CA}" = "0" ]; then
                      cat /etc/ssl/certs/homelab-ca.pem >> /etc/ssl/cert.pem
                      echo "    CA angehängt."
                    else
                      echo "    CA bereits im Bundle."
                    fi

                    set -e

                    # PHP-FPM braucht einen Moment zum Starten
                    sleep 10

                    # ── 2. Installation falls nötig ───────────────────────────
                    STATUS=$(su -s /bin/sh www-data -c \
                      "php /var/www/html/occ status --output=json 2>/dev/null" \
                      | grep -o '"installed":true' || true)

                    if [ -z "$STATUS" ]; then
                      echo "==> Installiere Nextcloud..."

                      # Leere config.php entfernen (vom Chart als Placeholder angelegt)
                      if [ -f /var/www/html/config/config.php ]; then
                        SIZE=$(stat -c%s /var/www/html/config/config.php)
                        if [ "$SIZE" -le 6 ]; then
                          rm -f /var/www/html/config/config.php
                        fi
                      fi

                      su -s /bin/sh www-data -c "
                        php /var/www/html/occ maintenance:install \
                          --database=pgsql \
                          --database-host=${POSTGRES_HOST} \
                          --database-name=${POSTGRES_DB} \
                          --database-user=${POSTGRES_USER} \
                          --database-pass=${POSTGRES_PASSWORD} \
                          --admin-user=${NEXTCLOUD_ADMIN_USER} \
                          --admin-pass=${NEXTCLOUD_ADMIN_PASSWORD} \
                          --data-dir=/var/www/html/data \
                          2>&1
                      "
                      echo "==> Installation abgeschlossen."
                    else
                      echo "==> Nextcloud bereits installiert, überspringe Installation."
                    fi

                    # ── 3. trusted_domain sicherstellen ──────────────────────
                    su -s /bin/sh www-data -c "
                      php /var/www/html/occ config:system:set \
                        trusted_domains 0 \
                        --value=nextcloud.homelab.local 2>/dev/null
                    " || true

                    # ── 4. Apps aktivieren ────────────────────────────────────
                    echo "==> Aktiviere Apps..."

                    activate_app() {
                      APP=$1
                      if ! su -s /bin/sh www-data -c \
                          "php /var/www/html/occ app:list --enabled 2>/dev/null" \
                          | grep -q "^  - ${APP}:"; then
                        su -s /bin/sh www-data -c \
                          "php /var/www/html/occ app:install ${APP} 2>/dev/null || \
                           php /var/www/html/occ app:enable ${APP} 2>/dev/null" || true
                        echo "    ${APP} aktiviert."
                      else
                        echo "    ${APP} bereits aktiv."
                      fi
                    }

                    # Kern-Integrationen
                    activate_app oidc_login
                    activate_app files_external

                    # Produktiv-Apps
                    activate_app mail
                    activate_app calendar
                    activate_app contacts
                    activate_app notes

                    echo "==> postStart abgeschlossen."

          extraEnv:
            - name: REDIS_HOST_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nextcloud-secret
                  key: redis-password
            # OIDC Client Secret – wird in oidc.config.php via getenv() gelesen.
            # Kommt damit nie als Klartext in Git oder eine ConfigMap.
            - name: OIDC_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: nextcloud-secret
                  key: oidc-client-secret

          # PHP-FPM Config für bessere Performance
          phpConfigs:
            www.conf: |
              [www]
              user = www-data
              group = www-data
              listen = 127.0.0.1:9000
              pm = dynamic
              pm.max_children = 20
              pm.start_servers = 5
              pm.min_spare_servers = 3
              pm.max_spare_servers = 10
              pm.max_requests = 500
              clear_env = no

          # defaultConfigs steuert welche Chart-internen Default-Configs gemountet werden.
          # redis.config.php: false verhindert den Chart-internen Mount.
          # Ohne diesen Eintrag würde das Chart redis.config.php zweimal mounten
          # (einmal intern, einmal aus configs:) → "must be unique" Fehler.
          defaultConfigs:
            redis.config.php: false

          # configs: werden vom Chart als ConfigMap angelegt und nach
          # /var/www/html/config/<n> gemountet. Keine eigenen VolumeMounts nötig.
          configs:
            redis.config.php: |-
              <?php
              $CONFIG = array(
                'memcache.local' => '\OC\Memcache\Redis',
                'memcache.distributed' => '\OC\Memcache\Redis',
                'memcache.locking' => '\OC\Memcache\Redis',
                'redis' => array(
                  'host' => 'redis-master.infrastructure.svc.cluster.local',
                  'port' => 6379,
                  'password' => getenv('REDIS_HOST_PASSWORD'),
                ),
              );

            proxy.config.php: |-
              <?php
              $CONFIG = array(
                'trusted_proxies' => ['10.0.0.0/8'],
                'overwriteprotocol' => 'https',
                'overwrite.cli.url' => 'https://nextcloud.homelab.local',
                'forwarded_for_headers' => ['HTTP_X_FORWARDED_FOR'],
              );

            misc.config.php: |-
              <?php
              $CONFIG = array(
                'default_phone_region' => 'DE',
                'maintenance_window_start' => 2,
                'loglevel' => 1,
              );

            # OIDC Login via Keycloak (oidc_login App).
            # Client Secret kommt aus Env-Variable – steht nie im Klartext in Git.
            #
            # groups wird NICHT als Scope angefordert – der Gruppen-Claim kommt
            # über den Group Membership Mapper im nextcloud-dedicated Client Scope
            # automatisch im Token. Keycloak gibt "invalid_scope" zurück wenn groups
            # als expliziter Scope angefordert wird ohne ihn als Client Scope zu
            # registrieren.
            #
            # oidc_login_disable_registration: false – muss explizit gesetzt werden!
            # Der Default in oidc_login 3.x ist true (invertierte Logik),
            # was dazu führt dass neue User nicht angelegt werden können.
            oidc.config.php: |-
              <?php
              $CONFIG = array(
                'oidc_login_provider_url'          => 'https://auth.homelab.local/realms/homelab',
                'oidc_login_client_id'             => 'nextcloud',
                'oidc_login_client_secret'         => getenv('OIDC_CLIENT_SECRET'),
                'oidc_login_auto_redirect'         => false,
                'oidc_login_hide_password_form'    => false,
                'oidc_login_disable_registration'  => false,
                'oidc_login_attributes'            => array(
                  'id'     => 'preferred_username',
                  'name'   => 'name',
                  'mail'   => 'email',
                  'groups' => 'groups',
                ),
                'oidc_login_create_user'           => true,
                'oidc_login_default_quota'         => '',
                'oidc_login_use_id_token'          => false,
                'oidc_login_tls_verify'            => true,
                'oidc_login_scope'                 => 'openid profile email',
                'oidc_login_code_challenge_method' => 'S256',
                'oidc_login_logout_url'            => 'https://auth.homelab.local/realms/homelab/protocol/openid-connect/logout',
                'oidc_login_button_text'           => 'Mit Keycloak anmelden',
              );

          # homelab-CA für TLS-Verifikation gegen auth.homelab.local.
          # Pfad: /etc/ssl/certs/ – wird vom Chart NICHT belegt, kein Konflikt möglich.
          extraVolumes:
            - name: homelab-ca
              secret:
                secretName: homelab-ca

          extraVolumeMounts:
            - name: homelab-ca
              mountPath: /etc/ssl/certs/homelab-ca.pem
              subPath: homelab-ca.crt
              readOnly: true

        internalDatabase:
          enabled: false

        externalDatabase:
          enabled: true
          type: postgresql
          host: homelab-pg-rw.infrastructure.svc.cluster.local
          port: 5432
          database: nextcloud
          user: nextcloud
          existingSecret:
            enabled: true
            secretName: nextcloud-secret
            usernameKey: db-username
            passwordKey: db-password
          # sslMode: disable – CNPG legt Client-Zertifikate unter /root/.postgresql/ ab,
          # aber Nextcloud läuft als www-data (UID 82) und hat keinen Lesezugriff auf /root/.
          # Innerhalb des Clusters (Pod → Service) ist SSL nicht notwendig.
          sslMode: disable

        redis:
          enabled: false # wir nutzen den bestehenden Redis

        # nginx Sidecar (required für fpm-alpine flavor)
        nginx:
          enabled: true

        persistence:
          enabled: true
          size: 10Gi # für Config, Apps, Previews – Nutzerdateien via Storage Box

        resources:
          requests:
            memory: 512Mi
            cpu: 250m
          limits:
            memory: 1Gi

        ingress:
          enabled: true
          className: traefik
          annotations:
            traefik.ingress.kubernetes.io/router.middlewares: productivity-nextcloud-headers@kubernetescrd
          hosts:
            - host: nextcloud.homelab.local
              paths:
                - path: /
                  pathType: Prefix
          tls:
            - secretName: homelab-wildcard-tls
              hosts:
                - nextcloud.homelab.local

        cronjob:
          enabled: true

        # Startup dauert länger wegen DB-Initialisierung beim ersten Start
        startupProbe:
          enabled: true
          initialDelaySeconds: 30
          periodSeconds: 10
          failureThreshold: 60

        livenessProbe:
          enabled: true
          initialDelaySeconds: 30

        readinessProbe:
          enabled: true
          initialDelaySeconds: 30

        # initContainers: nur noch für Volume-Vorbereitung zuständig.
        # CA-Registrierung und App-Aktivierung sind in den postStart Hook gewandert.
        initContainers:
          - name: setup-nextcloud-apps
            image: nextcloud:fpm-alpine
            command:
              - sh
              - -c
              - |
                echo "==> initContainer: bereit."
                echo "    CA-Registrierung und App-Aktivierung erfolgen im postStart Hook."
            volumeMounts:
              - name: nextcloud-main
                mountPath: /var/www/html
              - name: homelab-ca
                mountPath: /etc/ssl/certs/homelab-ca.pem
                subPath: homelab-ca.crt
                readOnly: true

  destination:
    server: https://kubernetes.default.svc
    namespace: productivity
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
