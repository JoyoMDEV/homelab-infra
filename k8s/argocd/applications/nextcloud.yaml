---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: nextcloud
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://nextcloud.github.io/helm
    chart: nextcloud
    # Chart 6.x hatte einen Bug: configs: + extraVolumeMounts erzeugten doppelte
    # mountPaths → "must be unique" Fehler. Chart 8.x behebt das.
    targetRevision: 8.*
    helm:
      values: |
        image:
          flavor: fpm-alpine

        nextcloud:
          host: nextcloud.homelab.local
          username: admin
          password: "" # gesetzt via existingSecret

          existingSecret:
            enabled: true
            secretName: nextcloud-secret
            usernameKey: nextcloud-username
            passwordKey: nextcloud-password

          extraEnv:
            - name: REDIS_HOST_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nextcloud-secret
                  key: redis-password
            # OIDC Client Secret – wird in oidc.config.php via getenv() gelesen.
            # Kommt damit nie als Klartext in Git oder eine ConfigMap.
            - name: OIDC_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: nextcloud-secret
                  key: oidc-client-secret

          # PHP-FPM Config für bessere Performance
          phpConfigs:
            www.conf: |
              [www]
              pm = dynamic
              pm.max_children = 20
              pm.start_servers = 5
              pm.min_spare_servers = 3
              pm.max_spare_servers = 10

          # defaultConfigs steuert welche Chart-internen Default-Configs gemountet werden.
          # redis.config.php: false verhindert den Chart-internen Mount.
          # Ohne diesen Eintrag würde das Chart redis.config.php zweimal mounten
          # (einmal intern, einmal aus configs:) → "must be unique" Fehler.
          defaultConfigs:
            redis.config.php: false

          # configs: werden vom Chart als ConfigMap angelegt und nach
          # /var/www/html/config/<n> gemountet. Keine eigenen VolumeMounts nötig.
          configs:
            redis.config.php: |-
              <?php
              $CONFIG = array(
                'memcache.local' => '\OC\Memcache\Redis',
                'memcache.distributed' => '\OC\Memcache\Redis',
                'memcache.locking' => '\OC\Memcache\Redis',
                'redis' => array(
                  'host' => 'redis-master.infrastructure.svc.cluster.local',
                  'port' => 6379,
                  'password' => getenv('REDIS_HOST_PASSWORD'),
                ),
              );

            proxy.config.php: |-
              <?php
              $CONFIG = array(
                'trusted_proxies' => ['10.0.0.0/8'],
                'overwriteprotocol' => 'https',
                'overwrite.cli.url' => 'https://nextcloud.homelab.local',
                'forwarded_for_headers' => ['HTTP_X_FORWARDED_FOR'],
              );

            misc.config.php: |-
              <?php
              $CONFIG = array(
                'default_phone_region' => 'DE',
                'maintenance_window_start' => 2,
                'loglevel' => 1,
              );

            # OIDC Login via Keycloak (oidc_login App).
            # Client Secret kommt aus Env-Variable – steht nie im Klartext in Git.
            oidc.config.php: |-
              <?php
              $CONFIG = array(
                'oidc_login_provider_url'          => 'https://auth.homelab.local/realms/homelab',
                'oidc_login_client_id'             => 'nextcloud',
                'oidc_login_client_secret'         => getenv('OIDC_CLIENT_SECRET'),
                'oidc_login_auto_redirect'         => false,
                'oidc_login_hide_password_form'    => false,
                'oidc_login_attributes'            => array(
                  'id'     => 'preferred_username',
                  'name'   => 'name',
                  'mail'   => 'email',
                  'groups' => 'groups',
                ),
                'oidc_login_create_user'           => true,
                'oidc_login_default_quota'         => '',
                'oidc_login_use_id_token'          => false,
                'oidc_login_tls_verify'            => true,
                'oidc_login_scope'                 => 'openid profile email groups',
                'oidc_login_code_challenge_method' => 'S256',
                'oidc_login_logout_url'            => 'https://auth.homelab.local/realms/homelab/protocol/openid-connect/logout',
                'oidc_login_button_text'           => 'Mit Keycloak anmelden',
              );

          # homelab-CA für TLS-Verifikation gegen auth.homelab.local.
          # Pfad: /etc/ssl/certs/ – wird vom Chart NICHT belegt, kein Konflikt möglich.
          extraVolumes:
            - name: homelab-ca
              secret:
                secretName: homelab-ca

          extraVolumeMounts:
            - name: homelab-ca
              mountPath: /etc/ssl/certs/homelab-ca.pem
              subPath: homelab-ca.crt
              readOnly: true

        internalDatabase:
          enabled: false

        externalDatabase:
          enabled: true
          type: postgresql
          host: homelab-pg-rw.infrastructure.svc.cluster.local
          port: 5432
          database: nextcloud
          # user wird ignoriert wenn existingSecret.usernameKey gesetzt ist
          user: nextcloud
          existingSecret:
            enabled: true
            secretName: nextcloud-secret
            usernameKey: db-username
            passwordKey: db-password
          # sslMode: disable – CNPG legt Client-Zertifikate unter /root/.postgresql/ ab,
          # aber Nextcloud läuft als www-data (UID 82) und hat keinen Lesezugriff auf /root/.
          # Innerhalb des Clusters (Pod → Service) ist SSL nicht notwendig.
          sslMode: disable

        redis:
          enabled: false # wir nutzen den bestehenden Redis

        # nginx Sidecar (required für fpm-alpine flavor)
        nginx:
          enabled: true

        persistence:
          enabled: true
          size: 10Gi # für Config, Apps, Previews – Nutzerdateien via Storage Box

        resources:
          requests:
            memory: 512Mi
            cpu: 250m
          limits:
            memory: 1Gi

        ingress:
          enabled: true
          className: traefik
          annotations:
            traefik.ingress.kubernetes.io/router.middlewares: productivity-nextcloud-headers@kubernetescrd
          hosts:
            - host: nextcloud.homelab.local
              paths:
                - path: /
                  pathType: Prefix
          tls:
            - secretName: homelab-wildcard-tls
              hosts:
                - nextcloud.homelab.local

        cronjob:
          enabled: true

        # Startup dauert länger wegen DB-Initialisierung beim ersten Start
        startupProbe:
          enabled: true
          initialDelaySeconds: 30
          periodSeconds: 10
          failureThreshold: 60

        livenessProbe:
          enabled: true
          initialDelaySeconds: 30

        readinessProbe:
          enabled: true
          initialDelaySeconds: 30

        # initContainers gehört in Chart 8.x auf Top-Level, NICHT unter nextcloud:
        # Installiert oidc_login + files_external Apps idempotent bei jedem Pod-Start.
        initContainers:
          - name: setup-nextcloud-apps
            image: nextcloud:fpm-alpine
            command:
              - sh
              - -c
              - |
                set -e

                # ── 1. homelab-CA im System-Trust-Store registrieren ──────────
                # Muss vor occ-Aufrufen passieren damit HTTPS gegen Keycloak
                # beim App-Download verifiziert werden kann.
                echo "==> Registriere homelab CA..."
                cp /etc/ssl/certs/homelab-ca.pem \
                   /usr/local/share/ca-certificates/homelab-ca.crt
                update-ca-certificates 2>/dev/null || true
                echo "    CA registriert."

                # ── 2. oidc_login App installieren (idempotent) ───────────────
                echo "==> Prüfe oidc_login App..."
                if php /var/www/html/occ app:list --enabled 2>/dev/null \
                    | grep -q 'oidc_login'; then
                  echo "    oidc_login bereits aktiv."
                else
                  echo "    Installiere oidc_login..."
                  php /var/www/html/occ app:install oidc_login 2>/dev/null || \
                  php /var/www/html/occ app:enable  oidc_login
                  echo "    oidc_login aktiviert."
                fi

                # ── 3. files_external App aktivieren (für Storage Box) ────────
                echo "==> Prüfe files_external App..."
                if php /var/www/html/occ app:list --enabled 2>/dev/null \
                    | grep -q 'files_external'; then
                  echo "    files_external bereits aktiv."
                else
                  echo "    Aktiviere files_external..."
                  php /var/www/html/occ app:enable files_external
                  echo "    files_external aktiviert."
                fi

                echo "==> initContainer abgeschlossen."
            volumeMounts:
              - name: nextcloud-main
                mountPath: /var/www/html
              - name: homelab-ca
                mountPath: /etc/ssl/certs/homelab-ca.pem
                subPath: homelab-ca.crt
                readOnly: true

  destination:
    server: https://kubernetes.default.svc
    namespace: productivity
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
