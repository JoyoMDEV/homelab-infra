---
- name: Wait for server to be reachable
  ansible.builtin.wait_for_connection:
    timeout: 60

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: Upgrade all packages
  ansible.builtin.apt:
    upgrade: dist

- name: Install base packages
  ansible.builtin.apt:
    name:
      - curl
      - wget
      - git
      - vim
      - htop
      - tmux
      - jq
      - unzip
      - apt-transport-https
      - ca-certificates
      - gnupg
      - lsb-release
      - ufw
      - fail2ban
      - unattended-upgrades
    state: present

- name: Set timezone
  community.general.timezone:
    name: Europe/Berlin

- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"

- name: Add hostname to /etc/hosts
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.1\.1'
    line: "127.0.1.1 {{ inventory_hostname }}"

- name: Configure SSH hardening
  ansible.builtin.template:
    src: sshd_config.j2
    dest: /etc/ssh/sshd_config
    owner: root
    group: root
    mode: "0644"
    validate: sshd -t -f %s
  notify: Restart sshd

- name: Configure UFW defaults
  ansible.builtin.template:
    src: ufw-defaults.j2
    dest: /etc/default/ufw
    owner: root
    group: root
    mode: "0644"

- name: Allow SSH through UFW
  community.general.ufw:
    rule: allow
    port: "22"
    proto: tcp

- name: Allow k3s API through UFW
  community.general.ufw:
    rule: allow
    port: "6443"
    proto: tcp

- name: Allow HTTP/HTTPS through UFW
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - "80"
    - "443"

- name: Enable UFW
  community.general.ufw:
    state: enabled
    default: deny
    direction: incoming

- name: Enable unattended-upgrades
  ansible.builtin.dpkg_selections:
    name: unattended-upgrades
    selection: install

- name: Reboot if kernel was updated
  ansible.builtin.stat:
    path: /var/run/reboot-required
  register: common_reboot_required

- name: Reboot server
  ansible.builtin.reboot:
    reboot_timeout: 100
  when: common_reboot_required.stat.exists
